<!doctype html>
<html lang="en" ng-app>
  <head>
    <title>Request Example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/bootstrap-responsive.min.css">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/custom.css">
    <style>
      body {
        padding-top: 60px;
      }
    </style>
    <script>
    function RequestController($scope) {
      var socket = io.connect();
      
      // Vars.
      
      var client_uuid_string = 'client.uuid';
      
      // ADMIN: Our login user/pass.
      $scope.userpass   = '';
      $scope.useradmin  = false;
      
      // Packets (try to init an exsiting client *ONLY* by UUID)
      // because the Server will load the rest of the Client model #todo
      $scope.client = {
        //uuid: String(localStorage[client_uuid_string] || ''),
        uuid: null,
        name: null,
        text: []
      };
      
      // Derived from bundles.values().
      $scope.packets = [];
      
      // New Message
      $scope.message = '';
      
      // Connect APIs.
      
      // Connect *ALL* clients.
      socket.on('connect', function () {
        $scope.register($scope.client);
      });
      
      // Register *UNIQUE* clients.
      $scope.register = function register(client) {
        socket.emit('register', client);
      };
      
      // Receive our payload Packet.
      socket.on('online', function (packet) {
        $scope.client = packet;        
        
        // Check if the packet is new?
        var existingIndex  = null;
        var existingPacket = $scope.packets.find(function (item, index, array) {
          existingIndex = index;
          (item.uuid == packet.uuid ? true : false);
        });

        // Either update-in-place or swizzle the new packet into $scope?
        if (existingPacket) {
          $scope.packets[existingIndex] = packet;
        } else {
          $scope.packets.push(packet);
        }

        // Store whatever (new or existing) UUID into localStorage.
        if (!localStorage[client_uuid_string]) {
          localStorage.setItem(client_uuid_string, $scope.client.uuid);
        }
        
        $scope.$apply();
      });
      
      // Message APIs.
      
      // Send a packet/request/message.
      $scope.submitMessage = function submitMessage() {
        socket.emit('message', $scope.client.uuid, $scope.message);
      };
      
      socket.on('update', function (packet) {
        // todo: support bundle changesets
        $scope.packets = [packet];
        console.log('message.packet:', packet);
        
        $scope.$apply();
      });
    }
    </script>
  </head>
  <body>
    <div class="container" ng-controller="RequestController">
      <div class="navbar navbar-fixed-top navbar-inverse">
        <div class="navbar-inner">
          <div class="pull-right">
            <a href="https://c9.io" class="brand">Cloud9 IDE</a>
          </div>
        </div>
      </div>

      <section id="requests" ng-model="requests">
        <header>
          <h1>Hi. All Messages(s)</h1>
        </header>
        <div class="row">
          <form ng-submit="submitMessage()">
          <div class="span12">
              <input type="text" class="span4" ng-model="client.name" placeholder="Nickname">
              <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th class="span3">Name</th>
                  <th class="span9">Text</th>
                </tr>
              </thead>
              <tbody>
                <tr ng-repeat="packet in packets">
                  <td class="span3" ng-bind="packet.name"></td>
                  <td class="span9">
                    <table class="table">
                      <tbody>
                        <tr ng-repeat="message in packet.text">
                          <td class="span9" ng-bind="message"></td>
                        </tr>
                      </tbody>
                    </table>
                  </td>
                </tr>
                <tr>
                  <td class="span3">
                    <input type="submit" class="btn btn-primary" value="Says!" ng-disabled="!message">
                  </td>
                  <td class="span9">
                    <input type="text" class="span7" ng-model="message" placeholder="Your Message">
                  </td>
                </tr>
              </tbody>
              </table>
          </div>
        </div>
        </form>
      </section>
      
      <!-- <header class="page-header row">
        <h1>Admin // Login</h1>
        <form ng-submit="login()">
          <div class="input-append">
            <input type="password" class="span6" ng-model="userpass" placeholder="">
            <input type="submit" class="btn btn-primary" value="Login" ng-disabled="!userpass">
          </div>
        </form>
      </header> -->
    
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/angular.min.js"></script>
  </body>
</html>
